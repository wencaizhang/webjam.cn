---
title: await-to-js çš„ä½¿ç”¨å’Œæºç åˆ†æ
slug: await-to-js
summary: TODO
date: '2024-06-05'
featured: true
tags:
  - å¼‚æ­¥
draft: true
featured_image_url: https://static.webjam.cn/images/202405/vscode-search-01.webp
---

## ä»‹ç» `await-to-js`

æœ€è¿‘å‘ç°äº†ä¸€ä¸ª [await-to-js](https://www.npmjs.com/package/await-to-js)ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠ promise åŒ…è£…ä¸€å±‚ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¤„ç†é”™è¯¯ã€‚

æˆ‘ä»¬çŸ¥é“ Promise çš„å‡ºç°è§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œasync await èƒ½å°†å¼‚æ­¥ä»£ç ä»¥åŒæ­¥ä»£ç çš„æ–¹å¼æ¥ä¹¦å†™ï¼Œä½†æ˜¯è¿™ä¸¤è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­éƒ½å°‘ä¸äº†å¯¹é”™è¯¯çš„æ•æ‰ï¼Œå‰è€…ä½¿ç”¨ [Promise.prototype.catch()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch) åè€…ä½¿ç”¨ [try...catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/try...catch)

```js
const p = Promise.reject('è¿™æ˜¯é”™è¯¯ä¿¡æ¯')
p.catch(err => {
  console.log(err)
})

// æˆ–è€…
try {
  const result = await p
} catch (err) {
  console.log(err)
}
```

æé†’ä¸€å¥ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæœ‰äº›åŒå­¦å«Œéº»çƒ¦ä¸å–œæ¬¢æ•æ‰é”™è¯¯ï¼Œä½†æ˜¯æˆ‘å¼ºçƒˆå»ºè®®ä¸è¦è¿™æ ·ï¼Œå¦åˆ™ä½ æ€»æœ‰ä¸€å¤©ä¼šè¿Ÿåˆ°è‹¦å¤´çš„ï¼ˆåˆ«é—®æˆ‘ä¸ºä»€ä¹ˆçŸ¥é“ğŸ˜­ï¼‰ã€‚

`await-to-js` çš„ä½œç”¨å°±æ˜¯æ›´ä¼˜é›…çš„å¤„ç†å¯¹é”™è¯¯çš„æ•æ‰ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
import to from 'await-to-js';

const [ err, data ] = await to(promiseFn(1));
```


å…¶ä¸­ `promiseFn` æ˜¯ä¸€ä¸ªè¿”å› Promise å®ä¾‹çš„å‡½æ•°ï¼Œæˆ‘ä»¬å‡å®šè¿™ä¸ª Promise æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›ç»“æœä¸º `data`ï¼Œæ‰§è¡Œå¤±è´¥æ—¶çš„é”™è¯¯ä¸º `error`ã€‚

ç»è¿‡ `to()` å‡½æ•°å¤„ç†ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œè¿™ä¸ªæ–°å®ä¾‹æœ€ç»ˆè¿”å›çš„æ•°æ®ç»“æ„æ˜¯å›ºå®šçš„ï¼Œå®ƒæ€»æ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå½“åŸ promise æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œæ–° promise è¿”å›çš„æ˜¯ `[null, data]`ï¼ŒåŸ promise æ‰§è¡Œå¤±è´¥æ—¶ï¼Œæ–° promise è¿”å›çš„æ˜¯ `[error, undefined]`ã€‚

![await-to-js](https://static.webjam.cn/images/202406/await-to-js.webp)

æ¢ç§è¯´æ³•å°±æ˜¯ `to()` å‡½æ•°è¿”å›äº†ä¸¤æŠŠåº§æ¤…ï¼Œç¬¬ä¸€æŠŠåº§æ¤…æ˜¯ `error` ä¸“å±ï¼Œå¦‚æœå‡ºç° `error` äº†ï¼Œå°±è®©å®ƒåä¸‹æ¥ï¼Œå¦‚æœæ²¡æœ‰ `error` å°±æŠŠæ¤…å­ç©ºç€ï¼Œç¬¬äºŒæŠŠåŒç†ï¼Œè¿™æ˜¯ `data` ä¸“å±ï¼ŒåŸ promise æ‰§è¡ŒæˆåŠŸäº†ï¼Œå°±è®©æ‰§è¡Œç»“æœåç¬¬äºŒæŠŠæ¤…å­ï¼Œè¦ä¸å°±ç©ºç€ã€‚

ä¹Ÿå› æ­¤ï¼Œä¸¤è€…ä¸å¯å…¼å¾—ï¼Œè‹¥æœ‰ `error` åˆ™æ—  `data`ï¼Œè‹¥æœ‰ `data` åˆ™æ—  `error`ã€‚æ‰€ä»¥å¯ä»¥æ ¹æ® `error` æ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­åŸ promise çš„æ‰§è¡ŒçŠ¶æ€ã€‚


## æºç 

æºç åœ°å€ï¼š[scopsy/await-to-js: Async await wrapper for easy error handling without try-catch](https://github.com/scopsy/await-to-js)

ä¸ºäº†å®¹æ˜“ç†è§£ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ç¼–è¯‘åçš„ js ä»£ç ï¼š

```js
/**
 * @param { Promise } promise
 * @param { Object= } errorExt - Additional Information you can pass to the err object
 * @return { Promise }
 */
function to(promise, errorExt) {
  return promise
    .then(function (data) { return [null, data]; })
    .catch(function (err) {
      if (errorExt) {
        Object.assign(err, errorExt);
      }
      return [err, undefined];
    });
}

export { to };
export default to;
//# sourceMappingURL=await-to-js.es5.js.map
```

æ²¡é”™ï¼Œå®é™…ä¸Šå°±åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«åœ¨åŸ promise çš„ `.then` å’Œ `.catch` ä¸­è¿”å›äº†å‰é¢è¯´çš„å›ºå®šç»“æ„çš„æ•°ç»„ã€‚

çœ‹äº†æºç æˆ‘ä»¬èƒ½å‘ç°æœ‰ä¸€ç‚¹æ˜¯ [await-to-js](https://www.npmjs.com/package/await-to-js) æ–‡æ¡£æ²¡æœ‰è¯´çš„ï¼Œ`to()` å‡½æ•°å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¼šè¢«åˆå¹¶åˆ° `error` é”™è¯¯å¯¹è±¡ä¸­ã€‚


å¦å¤–æœ‰ä¸€ä¸ª promise çš„åŸºç¡€çŸ¥è¯†å€¼å¾—æä¸€ä¸‹ï¼Œæˆ‘ä¼°è®¡å¾ˆå¤šåŒå­¦éƒ½æ²¡æ³¨æ„åˆ°ï¼Œé‚£å°±æ˜¯ `promise.catch()` å›è°ƒå‡½æ•°çš„è¿”å›å€¼å†³å®šäº†è¿™ä¸ª promise æœ€ç»ˆçŠ¶æ€ã€‚


```js
const p = () => {
  return setTimeout(() => {
    Promise.reject('é”™è¯¯ä¿¡æ¯')
  }, 10);
}
const p1 = p()
```

ä¸Šé¢çš„ `p()` å‡½æ•°ç›´æ¥æ‰§è¡Œï¼Œæœ€ç»ˆå°†å¾—åˆ°ä¸€ä¸ª `rejected` çŠ¶æ€çš„ Promise å®ä¾‹ï¼Œå¦‚æœç¨å¾®æ”¹å†™ä¸€ä¸‹ï¼š

```js
const p = () => {
  return setTimeout(() => {
    Promise.reject('é”™è¯¯ä¿¡æ¯')
  }, 10);
}
const p2 = p().catch(() => {
  // ä»€ä¹ˆéƒ½ä¸åš
})
```

æ·»åŠ ä¸€ä¸ª `.catch` å³ä½¿ä»€ä¹ˆéƒ½ä¸åšï¼Œ`p2` ä¹Ÿå°†å˜æˆ `fulfilled` çŠ¶æ€çš„çš„ Promise å®ä¾‹ã€‚

è¿™æ˜¯å› ä¸º p2 çš„ç»“æœï¼ˆçŠ¶æ€ï¼‰å…¶å®ä¾èµ–äº `.catch()` å›è°ƒå‡½æ•°çš„è¿”å›ç»“æœï¼Œå¦‚æœå›è°ƒå‡½æ•°è¿”å›äº† `promise.reject` æˆ–è€…æŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œè¿™ä¸ª promise çš„çŠ¶æ€ä¹Ÿä¼šå˜ä¸º `rejected`ã€‚

ç®€è€Œè¨€ä¹‹å°±æ˜¯ p2 çš„ç»“æœï¼ˆçŠ¶æ€ï¼‰ç”± `.then` å’Œ `.catch` æ‰§è¡Œé“¾æ¡ä¸­çš„æœ€åä¸€ä¸ªå†³å®šã€‚


## Reference
- [Promise - JavaScript | MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
- [Promise.prototype.catch() - JavaScript | MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)
- [try...catch - JavaScript | MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/try...catch)
- [await-to-js](https://www.npmjs.com/package/await-to-js)
- [scopsy/await-to-js: Async await wrapper for easy error handling without try-catch](https://github.com/scopsy/await-to-js)
