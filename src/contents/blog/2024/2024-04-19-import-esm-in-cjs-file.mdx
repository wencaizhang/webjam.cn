---
title: å¦‚ä½•åœ¨ CJS æ¨¡å—ä¸­å¼•å…¥ EJS æ¨¡å—
slug: import-esm-in-cjs-file
summary: 'å¦‚ä½•åœ¨ CJS æ¨¡å—ä¸­å¼•å…¥ EJS æ¨¡å—'
date: '2024-04-19'
featured: true
tags:
  - JS æ¨¡å—è§„èŒƒ
draft: true
featured_image_url: https://static.webjam.cn/images/202405/import-esm-in-cjs-file.webp
---

![](https://static.webjam.cn/images/202405/import-esm-in-cjs-file.webp)

å‰é¢å†™äº†å…³äº[å¦‚ä½•åœ¨ ESM æ¨¡å—ä¸­å¼•å…¥ CJS æ¨¡å—](./import-cjs-in-esm-file)çš„æ–‡ç« , æ²¡è¿‡å¤šä¹…å°±åˆé‡åˆ°äº†åœ¨ CJS æ¨¡å—ä¸­å¼•å…¥ ES æ¨¡å—çš„éœ€æ±‚ ğŸ˜…

## é—®é¢˜ä»‹ç»

äº‹æƒ…æ˜¯è¿™æ ·çš„, æˆ‘åŸºäº Nestjs å¼€å‘ä¸€ä¸ªé¡¹ç›®, å¼•å…¥äº†ä¸€ä¸ªçˆ¬è™«åº“ [coder-hxl/x-crawl](https://github.com/coder-hxl/x-crawl). ä½†æ˜¯å¼•å…¥è¿™ä¸ªåº“ä¹‹åæ€»æ˜¯æ‰¾ä¸åˆ°å¯¹åº”çš„æ¨¡å—, å› æ­¤æˆ‘è¿˜å»å¯¹åº” issues ä¸‹æäº†ä¸€å¥(è§[åˆ›å»ºå®ä¾‹æ—¶å€™ æŠ¥é”™ TypeError: (0 , x_crawl_1.default) is not a function Â· Issue #89 Â· coder-hxl/x-crawl](https://github.com/coder-hxl/x-crawl/issues/89)). ä½†æ˜¯ç»è¿‡å†æ¬¡å®¡æŸ¥å‘ç°, è¿™ä¸æ˜¯äººå®¶ x-crawl çš„ bug, è€Œæ˜¯å› ä¸ºåœ¨ CJS æ¨¡å—ä¸­å¼•å…¥ ES æ¨¡å—å¼•èµ·çš„é—®é¢˜.

## é—®é¢˜åˆ†æ

åœ¨å…·ä½“åˆ†æé—®é¢˜ä¹‹å‰, æˆ‘å…ˆå¤§è‡´æ¢³ç†ä¸€ä¸‹ä¸åŒè§„èŒƒçš„ npm åŒ…æ˜¯æ€ä¹ˆå¼•å…¥çš„.

npm åŒ…å¤§è‡´åˆ†ä¸ºä¸‰ç±», ç¬¬ä¸€ç±»æ˜¯ä»…æ”¯æŒ CJS è§„èŒƒçš„, è¿™ä¸€ç±»ä¸€èˆ¬éƒ½æ˜¯å¹´ä»£ç‰¹åˆ«ä¹…è¿œçš„ npm åŒ…, è€Œä¸”å·²ç»å¾ˆä¹…ä¸æ›´æ–°äº†, ç¬¬äºŒç±»æ˜¯åŒæ—¶æ”¯æŒ CJS å’Œ ESM è§„èŒƒ, å®ƒä»¬ä¸€èˆ¬é€šè¿‡æ‰“åŒ…å·¥å…·å®Œæˆå¯¹ä¸åŒè§„èŒƒçš„æ”¯æŒ, ç¬¬ä¸‰ç±»åˆ™æ˜¯åªæ”¯æŒ ESM è§„èŒƒ, å› ä¸ºåˆ›å»ºæ—¶é—´æ¯”è¾ƒæ™š, æ‰€ä»¥æ²¡æœ‰ CJS çš„å†å²åŒ…è¢±.

è¯´å›è¿™æ¬¡çš„é—®é¢˜, å› ä¸º Nestjs é»˜è®¤å°±æ˜¯ ESM è§„èŒƒçš„å†™æ³•, ä¾‹å¦‚ `import { log } from '../utils';`, æ‰€ä»¥æˆ‘å°±è®¤ä¸º Nestjs ä½¿ç”¨çš„æ˜¯ ESM è§„èŒƒ, è€Œ [coder-hxl/x-crawl](https://github.com/coder-hxl/x-crawl) ä¹Ÿæ˜¯æ”¯æŒ ESM è§„èŒƒçš„, ä½†å¼•å…¥ä¹‹åå´å§‹ç»ˆæŠ¥é”™æç¤ºæ¨¡å—å¼•å…¥é”™è¯¯.

ä½†å…¶å®å‘¢é—®é¢˜å‡ºåœ¨ Nestjs æ¡†æ¶ä¸Š, ä½¿ç”¨ Nestjs æ¡†æ¶å†™ä»£ç ä½¿ç”¨ ESM è§„èŒƒ, ä½†æ˜¯å®ƒæœ€ç»ˆæ‰“åŒ…äº§ç‰©å´ä½¿ç”¨äº† CJS è§„èŒƒ ğŸ˜¯. æˆ‘æŒ‰ç…§ ESM è§„èŒƒå†™å‡ºæ¥çš„ä»£ç , æœ€ç»ˆä¼šç¼–è¯‘æˆ CJS è§„èŒƒçš„ä»£ç , è€Œé€šè¿‡ `import` å¼•å…¥æ¨¡å—çš„è¯­å¥, ä¹Ÿä¼šå˜æˆ CJS è§„èŒƒä¸‹çš„ `require` è¯­å¥.

é—®é¢˜å°±å‡ºç°åœ¨è¿™ä¸€æ­¥, å¦‚æœæ˜¯å¼•å…¥äº† npm åŒ…, å› ä¸ºæ‰“åŒ…ä¹‹åå˜æˆäº† CJS è§„èŒƒçš„ `require` è¯­å¥è¿›è¡Œå¼•å…¥, å› æ­¤é‡åˆ°åªæ”¯æŒ ESM è§„èŒƒ, ä¸æ”¯æŒ CJS è§„èŒƒçš„ npm åŒ…, é‚£è‡ªç„¶æ˜¯æ¨¡å—å¯¼å…¥å¤±è´¥, æç¤ºå¼•å…¥é”™è¯¯ä¹Ÿå°±åˆæƒ…åˆç†äº†å§ ğŸ¤”

è€Œ [coder-hxl/x-crawl](https://github.com/coder-hxl/x-crawl) æ°æ°æ˜¯åœ¨ V10 ç‰ˆæœ¬å·²ç»ä¸å†æ”¯æŒ CJS ï¼Œåªèƒ½ä½¿ç”¨ ESM äº†, è¿™å°±å¯¼è‡´äº†åœ¨ Nestjs ä¸­æ— æ³•ç›´æ¥å¯¼å…¥ `x-crawl`

## è§£å†³æ–¹æ¡ˆé€‰æ‹©

å…¶å®é‡åˆ°ä¸åŒè§„èŒƒçš„æ¨¡å—ç›¸äº’å¼•å…¥çš„é—®é¢˜, å¯èƒ½å¤§å®¶ç¬¬ä¸€ååº”æ˜¯æŠŠé¡¹ç›®æ•´ä½“æ”¹æˆ CJS è§„èŒƒæˆ–è€… ESM è§„èŒƒ, å…·ä½“æ“ä½œå¤§è‡´æ˜¯ç»™ `package.json` æ·»åŠ  `"type": "module"`ï¼Œç»™ `tsconfig.json` æ·»åŠ  `"module": "ESNext"` å’Œ `"moduleResolution": "Bundler"` ç­‰ç­‰, æˆ‘å°è¯•äº†ä¸€ä¸‹, å‘ç°è¿™ä¸ªæ–¹æ³•ä¸å¤ªåˆé€‚.

ä¸€æ¥æ˜¯ä»£ç æ”¹åŠ¨å¤ªå¤§, ä½ éœ€è¦æŠŠå·²ç»å†™å¥½çš„ä»£ç å…¨éƒ¨æ”¹æˆå¦ä¸€ä¸ªè§„èŒƒ, äºŒæ¥æ˜¯æ¶‰åŠåˆ°ç¬¬ä¸‰æ–¹ npm åŒ…å’Œæ‰“åŒ…æ„å»ºå·¥å…·, ä¼šå¼•èµ·æ›´å¤šæ— æ³•é¢„æµ‹çš„é—®é¢˜, æ€»ä¹‹è¿™æ˜¯ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ, ä½†æ˜¯æ”¹åŠ¨æˆæœ¬ä¹Ÿéå¸¸å¤§.

è€Œä¸Šä¸€ç¯‡æ–‡ç« [å¦‚ä½•åœ¨ ESM æ¨¡å—ä¸­å¼•å…¥ CJS æ¨¡å—](./import-cjs-in-esm-file)å°±æ˜¯ä¸€ä¸ªå±€éƒ¨å¼•å…¥ä¸åŒè§„èŒƒæ¨¡å—çš„æ–¹æ¡ˆ, æ‰€ä»¥è¿™ä¸€æ¬¡, æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ä¸æ”¹åŠ¨æ•´ä½“ä»£ç , åªæƒ³åŠæ³•åœ¨ CJS æ¨¡å—ä¸­å¼•å…¥ ES æ¨¡å—.

ç»è¿‡ä¸€ç•ªç™¾ä¹‹è°·ä¹‹ä¹‹å, ç»ˆäºåœ¨ [Compile a package that depends on ESM only library into a CommonJS package - Stack Overflow](https://stackoverflow.com/questions/70545129/compile-a-package-that-depends-on-esm-only-library-into-a-commonjs-package/75939304#75939304) æ‰¾åˆ°äº†ä¸€ä¸ªå¾ˆç®€æ´çš„è§£å†³æ–¹æ¡ˆ.

```js
const importDynamic = new Function('modulePath', 'return import(modulePath)');
importDynamic('x-crawl').then((xCrawl) => {
  const { createCrawl } = xCrawl;
  // do something
});
```

`modulePath` åˆ™æ˜¯ ESM æ¨¡å—çš„ç›¸å¯¹è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„, å¦‚æœæ˜¯ npm åŒ…åˆ™ç›´æ¥å†™åŒ…åå³å¯.

å…³äºè¿™ä¸ªé—®é¢˜çš„å¤ç°ä»£ç æˆ‘ä¹Ÿå•ç‹¬åˆ›å»ºäº†ä¸€ä¸ª repo åœ¨è¿™é‡Œ [https://github.com/wencaizhang/nestjs-crawl-bug-demo](https://github.com/wencaizhang/nestjs-crawl-bug-demo) æœ‰å…´è¶£å¯ä»¥ç‹ ç‹ ç‚¹å‡»æŸ¥çœ‹å…·ä½“ä»£ç .

## å…¶ä»–

### åªæ”¯æŒ ESM çš„ npm åŒ…

- x-crawl ä» V10 ç‰ˆæœ¬å·²ç»ä¸å†æ”¯æŒ CJS ï¼Œåªèƒ½ä½¿ç”¨ ESM: [Release v10.0.0 Â· coder-hxl/x-crawl](https://github.com/coder-hxl/x-crawl/releases/tag/v10.0.0)
- Chalk v5 å¼€å§‹åªæ”¯æŒ ESM: [Release v5.0.0 Â· chalk/chalk](https://github.com/chalk/chalk/releases/tag/v5.0.0)

### æœåˆ°çš„èµ„æ–™

- [require() of ES Module ... not supported - Stack Overflow](https://stackoverflow.com/questions/70820079/error-err-require-esm-require-of-es-module-not-supported/77966870#77966870)
- [Compile a package that depends on ESM only library into a CommonJS package - Stack Overflow](https://stackoverflow.com/questions/70545129/compile-a-package-that-depends-on-esm-only-library-into-a-commonjs-package/75939304#75939304)
- [chatgpt_nestjs_server/src/openai.service.ts at main Â· RusDyn/chatgpt_nestjs_server](https://github.com/RusDyn/chatgpt_nestjs_server/blob/main/src/openai.service.ts#L5)

### ä¸€äº›æ–‡æ¡£

- [å…³äºçº¯ ESM åŒ… --- Pure ESM package](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c)
- [import()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import)
- [Function() æ„é€ å‡½æ•° - JavaScript | MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/Function)
